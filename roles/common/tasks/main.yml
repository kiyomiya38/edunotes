- name: Install base packages
  ansible.builtin.dnf:
    name: [git, tar, unzip, curl, wget]
    state: present

- name: Install Node Exporter
  ansible.builtin.get_url:
    url: https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
    dest: /tmp/node_exporter.tar.gz
- name: Extract node_exporter
  ansible.builtin.unarchive:
    src: /tmp/node_exporter.tar.gz
    dest: /opt/
    remote_src: yes
- name: Symlink node_exporter
  ansible.builtin.file:
    src: /opt/node_exporter-1.8.2.linux-amd64/node_exporter
    dest: /usr/local/bin/node_exporter
    state: link
- name: Create node_exporter service
  ansible.builtin.copy:
    dest: /etc/systemd/system/node_exporter.service
    content: |
      [Unit]
      Description=Prometheus Node Exporter
      After=network.target
      [Service]
      ExecStart=/usr/local/bin/node_exporter
      Restart=always
      [Install]
      WantedBy=multi-user.target
- name: Enable node_exporter
  ansible.builtin.systemd:
    name: node_exporter
    enabled: true
    state: started

# Fluent Bit â†’ CloudWatch Logs
- name: Install Fluent Bit
  ansible.builtin.dnf:
    name: td-agent-bit
    state: present
  vars:
    ansible_dnf_disable_gpg_check: true

- name: Configure Fluent Bit
  ansible.builtin.copy:
    dest: /etc/td-agent-bit/td-agent-bit.conf
    content: |
      [SERVICE]
          Flush        1
          Daemon       Off
          Log_Level    info
      [INPUT]
          Name        tail
          Path        /var/log/messages,/var/log/nginx/access.log,/var/log/nginx/error.log
          Tag         host.*
          Refresh_Interval 5
          Skip_Long_Lines On
      [OUTPUT]
          Name   cloudwatch_logs
          Match  host.*
          region ${AWS_REGION}
          log_group_name  /edunotes/hosts
          log_stream_name {hostname}
          auto_create_group true
- name: Enable Fluent Bit
  ansible.builtin.systemd:
    name: td-agent-bit
    enabled: true
    state: started
