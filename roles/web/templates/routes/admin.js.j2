// routes/admin.js
const express = require('express');
const router = express.Router();

function requireAdmin(req, res, next) {
  // Session must contain user with role 'admin'
  if (req.session && req.session.user && req.session.user.role === 'admin') return next();
  if (!req.session || !req.session.user) {
    return res.redirect('/admin/login');
  }
  return res.status(403).send('Forbidden');
}

router.get('/', requireAdmin, async (req, res) => {
  // Minimal dashboard example (user count, note count)
  const db = req.app.get('db'); // db handle is set in server.js
  let stats = { users: 0, notes: 0 };
  try {
    const u = await db.query('SELECT COUNT(*)::int AS c FROM users');
    const n = await db.query('SELECT COUNT(*)::int AS c FROM notes');
    stats.users = u.rows[0].c; stats.notes = n.rows[0].c;
  } catch (e) { /* noop */ }

  // Pass CSRF token to the view (explicit)
  const token = (typeof req.csrfToken === 'function') ? req.csrfToken() : '';
  res.render('admin/index', { title: 'Admin', stats, csrfToken: token });
 });
module.exports = router;

