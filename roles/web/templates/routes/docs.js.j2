// routes/docs.js
const express = require('express');
const fs = require('fs');
const path = require('path');
const matter = require('gray-matter');
const MarkdownIt = require('markdown-it');

const router = express.Router();
const docsDir = process.env.DOCS_DIR || path.join(process.cwd(), 'docs');
const md = new MarkdownIt({ html: false, linkify: true, breaks: true });

router.get('/', async (req, res) => {
  let files = [];
  try {
    files = fs.readdirSync(docsDir)
      .filter(f => f.toLowerCase().endsWith('.md'))
      .sort();
  } catch (_) {}
  res.render('docs/index', { title: 'Docs', files });
});

router.get('/:slug', async (req, res) => {
  const slug = req.params.slug.replace(/[^a-zA-Z0-9_\-\.]/g, '');
  const file = path.join(docsDir, `${slug}.md`);
  if (!fs.existsSync(file)) return res.status(404).send('Not found');

  const raw = fs.readFileSync(file, 'utf8');
  const { content, data } = matter(raw);
  const html = md.render(content);
  res.render('docs/show', { title: data.title || slug, meta: data, html });
});

module.exports = router;
