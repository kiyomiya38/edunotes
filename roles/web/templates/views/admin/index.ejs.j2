<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><%= title || "ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" %></title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto; max-width: 980px; margin: 24px auto; padding: 0 16px; line-height: 1.6; }
    h1 { margin-bottom:.5rem; }
    ul { list-style: disc; padding-left: 1.5em; }
    a { color:#06c; text-decoration:none } a:hover{ text-decoration:underline }
    section { margin-top:2rem }
    form { border:1px solid #e5e7eb; border-radius:10px; padding:16px; margin-top:.75rem }
    form h3{ margin:0 0 .5rem 0 }
    label{ display:block; margin:.55rem 0 .25rem; font-weight:600 }
    input[type=text]{ width:100%; max-width:560px; padding:.5rem; border:1px solid #cbd5e1; border-radius:8px }
    input[type=file], textarea{ width:100%; max-width:560px }
    textarea{ min-height:160px; padding:.5rem; border:1px solid #cbd5e1; border-radius:8px }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    .btn{ display:inline-block; padding:.55rem .9rem; border:1px solid #cbd5e1; border-radius:8px; background:#f8fafc; cursor:pointer }
    .btn.primary{ background:#0a66ff; color:#fff; border-color:#0a66ff }
    .muted{ color:#64748b; font-size:.95rem }
    .ok{ color:#067d00 } .err{ color:#c00 }
    progress{ width: 320px; height: 10px; }
    .tips{ font-size:.9rem; color:#475569 }
  </style>
</head>
<body>
  <h1>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <ul>
    <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: <strong><%= stats.users %></strong></li>
    <li>ãƒãƒ¼ãƒˆæ•°: <strong><%= stats.notes %></strong></li>
  </ul>

  <p><a href="/docs">â†’ å—è¬›ãƒãƒ‹ãƒ¥ã‚¢ãƒ« (/docs)</a></p>

  <section>
    <h2>æ•™æç®¡ç†ï¼ˆå—è¬›è€…å‘ã‘ãƒšãƒ¼ã‚¸ï¼‰</h2>
    <ul>
      <li><a href="/courses">ğŸ“˜ æ•™æãƒ†ã‚­ã‚¹ãƒˆä¸€è¦§</a></li>
      <li><a href="/vod">ğŸ¥ è¬›ç¾©å‹•ç”»ä¸€è¦§</a></li>
    </ul>
  </section>

  <section>
    <h2>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒŸãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ï¼‰</h2>

    <!-- 1) ãƒ†ã‚­ã‚¹ãƒˆæ•™æï¼š.md ã‚’èª­ã‚“ã§æœ¬æ–‡ã¨ã—ã¦ä¿å­˜ -->
    <form id="form-text">
      <h3>ğŸ“˜ ãƒ†ã‚­ã‚¹ãƒˆï¼ˆMarkdownï¼‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>

      <label for="t-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="t-title" type="text" placeholder="ä¾‹ï¼‰ç¬¬1å› ã‚¤ãƒ³ãƒˆãƒ­" required />

      <label for="t-slug">ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLè­˜åˆ¥å­ï¼‰</label>
      <!-- required ã‚’å‰Šé™¤ï¼ˆä»»æ„å…¥åŠ›ï¼‰ -->
      <input id="t-slug" type="text" placeholder="ä¾‹ï¼‰intro-1" />

      <label for="t-file">Markdown ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.mdï¼‰</label>
      <input id="t-file" type="file" accept=".md,text/markdown,text/plain" required />

      <div class="row" style="margin-top:.5rem">
        <label class="row" style="font-weight:normal">
          <input id="t-publish" type="checkbox" checked /> å…¬é–‹ã™ã‚‹ï¼ˆå—è¬›è€…ã«è¡¨ç¤ºï¼‰
        </label>
        <button class="btn primary" type="submit">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ä½œæˆ</button>
        <span id="t-msg" class="muted"></span>
      </div>
      <p class="tips">ä½œæˆå¾Œã¯ <code>/courses</code> ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </form>

    <!-- 2) å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³ï¼šmp4 ã‚’ S3 ç›´PUTï¼ˆäº‹å‰ç½²åï¼‰ -->
    <form id="form-video">
      <h3>ğŸ¥ å‹•ç”»ï¼ˆMP4ï¼‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>

      <label for="v-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="v-title" type="text" placeholder="ä¾‹ï¼‰ç¬¬1å› è¬›ç¾©å‹•ç”»" required />

      <label for="v-slug">ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLè­˜åˆ¥å­ï¼‰</label>
      <!-- required ã‚’å‰Šé™¤ï¼ˆä»»æ„å…¥åŠ›ï¼‰ -->
      <input id="v-slug" type="text" placeholder="ä¾‹ï¼‰video-1" />

      <label for="v-file">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.mp4ï¼‰</label>
      <input id="v-file" type="file" accept="video/mp4" required />

      <div class="row" style="margin-top:.5rem">
        <button class="btn primary" type="submit">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ä½œæˆ</button>
        <progress id="v-progress" value="0" max="100" style="display:none"></progress>
        <span id="v-msg" class="muted"></span>
      </div>
      <p class="tips">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã«è‡ªå‹•ã§å…¬é–‹ã—ã¾ã™ï¼ˆå—è¬›è€…ã¯ <code>/vod</code> ã‹ã‚‰å†ç”Ÿï¼‰ã€‚</p>
    </form>
  </section>

  <script>
    async function postJSON(url, body) {
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body),
        credentials: 'same-origin'   // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼é€ä¿¡
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function putJSON(url, body) {
      const r = await fetch(url, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body),
        credentials: 'same-origin'   // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼é€ä¿¡
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function patchJSON(url, body) {
      const r = await fetch(url, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body),
        credentials: 'same-origin'   // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼é€ä¿¡
      });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    /* ==== è¿½åŠ ï¼šã‚¹ãƒ©ãƒƒã‚°è‡ªå‹•ç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & è‡ªå‹•è£œå®Œ ==== */
    function makeSlug(input, fallback = 'item') {
      const base = String(input || '')
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^\w\s-]/g, ' ')
        .replace(/[_\s]+/g, '-')
        .toLowerCase()
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '');
      return (base || fallback).slice(0, 80);
    }

    // ãƒ†ã‚­ã‚¹ãƒˆï¼šã‚¿ã‚¤ãƒˆãƒ«/ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•è£œå®Œ
    const tTitle = document.getElementById('t-title');
    const tSlug  = document.getElementById('t-slug');
    const tFile  = document.getElementById('t-file');
    tTitle?.addEventListener('input', () => { if (!tSlug.value.trim()) tSlug.value = makeSlug(tTitle.value); });
    tFile?.addEventListener('change', () => {
      if (!tSlug.value.trim() && tFile.files[0]) {
        tSlug.value = makeSlug(tFile.files[0].name.replace(/\.[^.]+$/, ''), 'text');
      }
    });

    // å‹•ç”»ï¼šã‚¿ã‚¤ãƒˆãƒ«/ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•è£œå®Œ
    const vTitle = document.getElementById('v-title');
    const vSlug  = document.getElementById('v-slug');
    const vFile  = document.getElementById('v-file');
    vTitle?.addEventListener('input', () => { if (!vSlug.value.trim()) vSlug.value = makeSlug(vTitle.value); });
    vFile?.addEventListener('change', () => {
      if (!vSlug.value.trim() && vFile.files[0]) {
        vSlug.value = makeSlug(vFile.files[0].name.replace(/\.[^.]+$/, ''), 'video');
      }
    });
    /* ==== è‡ªå‹•ç”Ÿæˆã“ã“ã¾ã§ ==== */

    // ===== 1) ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ.mdï¼‰ =====
    document.getElementById('form-text').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('t-msg');
      msg.className = 'muted';
      msg.textContent = 'ä½œæˆä¸­â€¦';

      try {
        const title = document.getElementById('t-title').value.trim();
        // ç©ºãªã‚‰é€ä¿¡ç›´å‰ã«è‡ªå‹•ç”Ÿæˆï¼ˆä¿é™ºï¼‰
        const slugInput = document.getElementById('t-slug').value.trim();
        const file  = document.getElementById('t-file').files[0];
        const pub   = document.getElementById('t-publish').checked;
        if (!file) throw new Error('Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');

        // ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’èª­ã‚€
        const body_md = await new Promise((res, rej) => {
          const fr = new FileReader();
          fr.onerror = () => rej(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—'));
          fr.onload = () => res(String(fr.result || ''));
          fr.readAsText(file, 'utf-8');
        });

        const slug = slugInput || makeSlug(title || (file?.name.replace(/\.[^.]+$/, '') || 'text'));

        // 1) ãƒ¬ãƒƒã‚¹ãƒ³ä½œæˆ
        const { id } = await postJSON('/admin/lessons', { title, slug, type:'text' });
        // 2) æœ¬æ–‡ä¿å­˜
        await putJSON(`/admin/lessons/${id}/text`, { body_md });
        // 3) å…¬é–‹
        if (pub) await patchJSON(`/admin/lessons/${id}`, { published:true, visibility:'public' });

        msg.className = 'ok';
        msg.textContent = `ä½œæˆã—ã¾ã—ãŸï¼ˆID: ${id}ï¼‰ã€‚ä¸€è¦§ã¸ç§»å‹•ã—ã¾ã™â€¦`;
        setTimeout(() => location.href = '/courses', 600);
      } catch (err) {
        console.error(err);
        msg.className = 'err';
        msg.textContent = 'å¤±æ•—ï¼š' + (err?.message || 'unknown');
      }
    });

    // ===== 2) å‹•ç”»ï¼ˆmp4 â†’ S3ç›´PUTï¼‰ =====
    document.getElementById('form-video').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('v-msg');
      const bar = document.getElementById('v-progress');
      msg.className = 'muted';
      msg.textContent = 'ä½œæˆä¸­â€¦';

      try {
        const title = document.getElementById('v-title').value.trim();
        const slugInput = document.getElementById('v-slug').value.trim();
        const file  = document.getElementById('v-file').files[0];
        if (!file) throw new Error('å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.mp4ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„');

        const slug = slugInput || makeSlug(title || (file?.name.replace(/\.[^.]+$/, '') || 'video'));

        // 1) ãƒ¬ãƒƒã‚¹ãƒ³æ 
        const { id } = await postJSON('/admin/lessons', { title, slug, type:'video' });

        // 2) presign ã‚’å–å¾—
        const presign = await postJSON(`/admin/lessons/${id}/video/presign`, {
          filename: file.name,
          size: file.size,
          contentType: file.type || 'video/mp4'
        });

        // 3) S3 ã¸ç›´PUTï¼ˆé€²æ—è¡¨ç¤ºï¼‰
        await new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open('PUT', presign.url);
          xhr.setRequestHeader('Content-Type', file.type || 'video/mp4');
          xhr.upload.onprogress = (ev) => {
            if (ev.lengthComputable) {
              bar.style.display = '';
              bar.value = Math.round(ev.loaded / ev.total * 100);
            }
          };
          xhr.onerror = () => reject(new Error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—'));
          xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error('S3å¿œç­”ã‚³ãƒ¼ãƒ‰: ' + xhr.status));
          xhr.send(file);
        });

        // 4) å®Œäº†é€šçŸ¥ + å…¬é–‹
        await postJSON(`/admin/lessons/${id}/video/complete`, {
          s3_key: presign.key,
          size: file.size,
          duration_sec: null
        });
        await patchJSON(`/admin/lessons/${id}`, { published:true, visibility:'public' });

        msg.className = 'ok';
        msg.textContent = `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ»å…¬é–‹ã—ã¾ã—ãŸï¼ˆID: ${id}ï¼‰ã€‚ä¸€è¦§ã¸ç§»å‹•ã—ã¾ã™â€¦`;
        setTimeout(() => location.href = '/vod', 800);
      } catch (err) {
        console.error(err);
        msg.className = 'err';
        msg.textContent = 'å¤±æ•—ï¼š' + (err?.message || 'unknown');
      } finally {
        bar.style.display = 'none';
        bar.value = 0;
      }
    });
  </script>
</body>
</html>
