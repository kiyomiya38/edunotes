<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title><%= title || "ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" %></title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto; max-width: 960px; margin: 24px auto; padding: 0 16px; line-height: 1.6; }
    h1 { margin-bottom: .5em; }
    ul { list-style: disc; padding-left: 1.5em; }
    a { color:#06c; text-decoration:none; } a:hover{ text-decoration:underline; }
    section { margin-top: 2rem; }
    form { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-top: .75rem; }
    form h3 { margin: 0 0 .5rem 0; }
    label { display:block; margin:.5rem 0 .25rem; font-weight: 600; }
    input[type=text] { width:100%; max-width:520px; padding:.5rem; border:1px solid #ccc; border-radius:6px; }
    textarea { width:100%; min-height:140px; padding:.5rem; border:1px solid #ccc; border-radius:6px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn { display:inline-block; padding:.5rem .9rem; border:1px solid #ccc; border-radius:8px; background:#f6f7f8; cursor:pointer; }
    .btn.primary { background:#0a66ff; color:#fff; border-color:#0a66ff; }
    .muted { color:#666; font-size:.95rem; }
    .ok { color:#067d00; }
    .err { color:#c00; }
    .hint { font-size:.9rem; color:#555; }
    code { background:#f3f4f6; padding:.1rem .3rem; border-radius:4px; }
  </style>
</head>
<body>
  <h1>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <ul>
    <li>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°: <strong><%= stats.users %></strong></li>
    <li>ãƒãƒ¼ãƒˆæ•°: <strong><%= stats.notes %></strong></li>
  </ul>

  <p><a href="/docs">â†’ å—è¬›ãƒãƒ‹ãƒ¥ã‚¢ãƒ« (/docs)</a></p>

  <section>
    <h2>æ•™æç®¡ç†ï¼ˆå—è¬›è€…å´ãƒšãƒ¼ã‚¸ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼‰</h2>
    <ul>
      <li><a href="/courses">ğŸ“˜ æ•™æãƒ†ã‚­ã‚¹ãƒˆä¸€è¦§</a></li>
      <li><a href="/vod">ğŸ¥ è¬›ç¾©å‹•ç”»ä¸€è¦§</a></li>
      <li><a href="/uploader.html">â¬†ï¸ è¬›ç¾©å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆç®¡ç†è€…ï¼‰</a></li>
    </ul>
  </section>

  <section>
    <h2>æ–°è¦ä½œæˆï¼ˆãƒŸãƒ‹ãƒ•ã‚©ãƒ¼ãƒ ï¼‰</h2>

    <!-- 1) ãƒ†ã‚­ã‚¹ãƒˆæ•™æ -->
    <form id="form-text">
      <h3>ğŸ“˜ æ–°è¦ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ</h3>
      <label for="t-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="t-title" type="text" placeholder="ä¾‹ï¼‰ç¬¬1å› ã‚¤ãƒ³ãƒˆãƒ­" required />

      <label for="t-slug">ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLè­˜åˆ¥å­ï¼‰</label>
      <input id="t-slug" type="text" placeholder="ä¾‹ï¼‰intro-1ï¼ˆåŠè§’è‹±æ•°ã¨ - _ï¼‰" required />

      <label for="t-body">æœ¬æ–‡ï¼ˆMarkdownï¼‰</label>
      <textarea id="t-body" placeholder="# è¦‹å‡ºã—&#10;æœ¬æ–‡ã‚’ã“ã“ã«â€¦"></textarea>

      <div class="row" style="margin-top:.5rem;">
        <label class="row" style="font-weight:normal;">
          <input id="t-publish" type="checkbox" checked />
          å…¬é–‹ã™ã‚‹ï¼ˆå—è¬›è€…ã«è¡¨ç¤ºï¼‰
        </label>
        <button class="btn primary" type="submit">ä½œæˆ</button>
        <span id="t-msg" class="muted"></span>
      </div>
      <p class="hint">ä½œæˆå¾Œã€<code>/courses</code> ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </form>

    <!-- 2) å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³ -->
    <form id="form-video">
      <h3>ğŸ¥ æ–°è¦å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³ä½œæˆ</h3>
      <label for="v-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="v-title" type="text" placeholder="ä¾‹ï¼‰ç¬¬1å› è¬›ç¾©å‹•ç”»" required />

      <label for="v-slug">ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLè­˜åˆ¥å­ï¼‰</label>
      <input id="v-slug" type="text" placeholder="ä¾‹ï¼‰video-1" required />

      <div class="row" style="margin-top:.5rem;">
        <button class="btn primary" type="submit">ãƒ¬ãƒƒã‚¹ãƒ³æ ã‚’ä½œæˆ</button>
        <span id="v-msg" class="muted"></span>
      </div>
      <p class="hint">ä½œæˆã™ã‚‹ã¨ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ï¼ˆ/uploader.htmlï¼‰ã€ã¸ã®ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰â†’<code>å…¬é–‹</code>ã™ã‚‹ã¨<code>/vod</code>ã«å‡ºã¾ã™ã€‚</p>
    </form>
  </section>

  <script>
    async function postJSON(url, body) {
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function putJSON(url, body) {
      const r = await fetch(url, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    async function patchJSON(url, body) {
      const r = await fetch(url, { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // --- ãƒ†ã‚­ã‚¹ãƒˆæ•™æ ---
    document.getElementById('form-text').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('t-msg');
      msg.textContent = 'ä½œæˆä¸­â€¦';
      try {
        const title = document.getElementById('t-title').value.trim();
        const slug  = document.getElementById('t-slug').value.trim();
        const body  = document.getElementById('t-body').value;
        const pub   = document.getElementById('t-publish').checked;

        // 1) ãƒ¬ãƒƒã‚¹ãƒ³ä½œæˆ
        const { id } = await postJSON('/admin/lessons', { title, slug, type:'text' });
        // 2) æœ¬æ–‡ä¿å­˜
        await putJSON(`/admin/lessons/${id}/text`, { body_md: body || '# æ–°è¦ãƒ†ã‚­ã‚¹ãƒˆ' });
        // 3) å…¬é–‹è¨­å®š
        if (pub) await patchJSON(`/admin/lessons/${id}`, { published:true, visibility:'public' });

        msg.className = 'ok';
        msg.textContent = `ä½œæˆã—ã¾ã—ãŸï¼ˆID: ${id}ï¼‰ã€‚ä¸€è¦§ã¸ç§»å‹•ã—ã¾ã™â€¦`;
        setTimeout(()=> location.href='/courses', 600);
      } catch (err) {
        console.error(err);
        msg.className = 'err';
        msg.textContent = 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + (err?.message || 'unknown');
      }
    });

    // --- å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³ ---
    document.getElementById('form-video').addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('v-msg');
      msg.textContent = 'ä½œæˆä¸­â€¦';
      try {
        const title = document.getElementById('v-title').value.trim();
        const slug  = document.getElementById('v-slug').value.trim();

        // 1) ãƒ¬ãƒƒã‚¹ãƒ³ä½œæˆï¼ˆå‹•ç”»ï¼‰
        const { id } = await postJSON('/admin/lessons', { title, slug, type:'video' });

        // 2) æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰â†’å…¬é–‹ï¼‰
        msg.className = 'ok';
        const upl = `/uploader.html?lessonId=${encodeURIComponent(id)}`;
        msg.innerHTML = `ãƒ¬ãƒƒã‚¹ãƒ³æ ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆID: <b>${id}</b>ï¼‰ã€‚<a href="${upl}">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã‚’é–‹ã</a> / <a href="/vod">å‹•ç”»ä¸€è¦§ã‚’è¦‹ã‚‹</a>`;

        // è£œåŠ©ï¼šuploader.html ãŒã‚¯ã‚¨ãƒªã‚’èª­ã‚ãªãã¦ã‚‚ã€å…¥åŠ›æ¬„ã«ã‚³ãƒ”ãƒšã§ãã‚‹ã‚ˆã† alert ã‚‚å‡ºã™
        alert('å‹•ç”»ãƒ¬ãƒƒã‚¹ãƒ³ID: ' + id + '\\nã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢: ' + upl);
      } catch (err) {
        console.error(err);
        msg.className = 'err';
        msg.textContent = 'ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + (err?.message || 'unknown');
      }
    });
  </script>
</body>
</html>
