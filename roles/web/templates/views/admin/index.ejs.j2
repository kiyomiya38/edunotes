<%- include('../layout', { title: '講師スタジオ | EduNotes', body: `
<section class="container">
  <div class="hero">
    <span class="badge">講師スタジオ</span>
    <h1 class="hero__title">教材を安心して公開。</h1>
    <p class="hero__subtitle">テキストと動画を作成し、短時間で公開できます。</p>
  </div>

  <div class="section grid">
    <div class="card">
      <div class="card__eyebrow">概要</div>
      <h3>受講者数</h3>
      <p style="font-size:2rem; margin:0;">${stats.users}</p>
      <p class="muted">全コースの受講者数。</p>
    </div>
    <div class="card">
      <div class="card__eyebrow">ノート</div>
      <h3>作成されたノート</h3>
      <p style="font-size:2rem; margin:0;">${stats.notes}</p>
      <p class="muted">受講者が作成した学習ノート。</p>
    </div>
    <div class="card">
      <div class="card__eyebrow">リンク</div>
      <p><a href="/courses">コース一覧</a></p>
      <p><a href="/vod">動画一覧</a></p>
      <p><a href="/docs">学習ガイド</a></p>
    </div>
  </div>

  <div class="section split">
    <div class="card">
      <div class="card__eyebrow">テキスト教材</div>
      <h2>Markdown教材をアップロード</h2>
      <form id="form-text" class="form">
        <label for="t-title">タイトル</label>
        <input id="t-title" type="text" placeholder="例: 第1章 イントロ" required>

        <label for="t-slug">スラッグ</label>
        <input id="t-slug" type="text" placeholder="intro-1">

        <label for="t-file">Markdownファイル (.md)</label>
        <input id="t-file" type="file" accept=".md,text/markdown,text/plain" required>

        <label>
          <input id="t-publish" type="checkbox" checked> 受講者に公開する
        </label>

        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button class="btn btn--primary" type="submit">作成する</button>
          <span id="t-msg" class="muted"></span>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="card__eyebrow">動画教材</div>
      <h2>MP4動画をアップロード</h2>
      <form id="form-video" class="form">
        <label for="v-title">タイトル</label>
        <input id="v-title" type="text" placeholder="例: 第1章 講義動画" required>

        <label for="v-slug">スラッグ</label>
        <input id="v-slug" type="text" placeholder="video-1">

        <label for="v-file">動画ファイル (.mp4)</label>
        <input id="v-file" type="file" accept="video/mp4" required>

        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button class="btn btn--primary" type="submit">アップロード</button>
          <progress id="v-progress" value="0" max="100" style="display:none"></progress>
          <span id="v-msg" class="muted"></span>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  const CSRF = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  const jsonHeaders = () => ({ 'Content-Type':'application/json', 'X-CSRF-Token': CSRF });

  async function postJSON(url, body) {
    const r = await fetch(url, { method:'POST', headers: jsonHeaders(), body: JSON.stringify(body), credentials:'same-origin' });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }
  async function putJSON(url, body) {
    const r = await fetch(url, { method:'PUT', headers: jsonHeaders(), body: JSON.stringify(body), credentials:'same-origin' });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }
  async function patchJSON(url, body) {
    const r = await fetch(url, { method:'PATCH', headers: jsonHeaders(), body: JSON.stringify(body), credentials:'same-origin' });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function makeSlug(input, fallback) {
    const base = String(input || '')
      .normalize('NFKD')
      .replace(/[\\u0300-\\u036f]/g, '')
      .replace(/[^\\w\\s-]/g, ' ')
      .replace(/[_\\s]+/g, '-')
      .toLowerCase()
      .replace(/-+/g, '-')
      .replace(/^-+|-+$/g, '');
    return (base || fallback).slice(0, 80);
  }

  const tTitle = document.getElementById('t-title');
  const tSlug  = document.getElementById('t-slug');
  const tFile  = document.getElementById('t-file');
  tTitle?.addEventListener('input', () => { if (!tSlug.value.trim()) tSlug.value = makeSlug(tTitle.value, 'text'); });
  tFile?.addEventListener('change', () => {
    if (!tSlug.value.trim() && tFile.files[0]) tSlug.value = makeSlug(tFile.files[0].name.replace(/\\.[^.]+$/, ''), 'text');
  });

  const vTitle = document.getElementById('v-title');
  const vSlug  = document.getElementById('v-slug');
  const vFile  = document.getElementById('v-file');
  vTitle?.addEventListener('input', () => { if (!vSlug.value.trim()) vSlug.value = makeSlug(vTitle.value, 'video'); });
  vFile?.addEventListener('change', () => {
    if (!vSlug.value.trim() && vFile.files[0]) vSlug.value = makeSlug(vFile.files[0].name.replace(/\\.[^.]+$/, ''), 'video');
  });

  document.getElementById('form-text').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('t-msg');
    msg.className = 'muted';
    msg.textContent = '作成中...';
    try {
      const title = tTitle.value.trim();
      const slugInput = tSlug.value.trim();
      const file  = tFile.files[0];
      const pub   = document.getElementById('t-publish').checked;
      if (!file) throw new Error('Markdownファイルを選択してください');

      const body_md = await new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onerror = () => rej(new Error('ファイルの読み込みに失敗しました'));
        fr.onload  = () => res(String(fr.result || ''));
        fr.readAsText(file, 'utf-8');
      });

      const slug = slugInput || makeSlug(title || (file?.name.replace(/\\.[^.]+$/, '') || 'text'), 'text');

      const created = await postJSON('/api/admin/lessons', { title, slug, type:'text' });
      await putJSON('/api/admin/lessons/' + created.id + '/text', { body_md });
      if (pub) {
        await postJSON('/api/admin/lessons/' + created.id + '/publish', { published:true, visibility:'public' });
      }

      msg.className = 'ok';
      msg.textContent = '作成しました。ID: ' + created.id + '。ページを移動します...';
      setTimeout(() => location.href = '/courses', 600);
    } catch (err) {
      console.error(err);
      msg.className = 'err';
      msg.textContent = '失敗しました: ' + (err?.message || '不明なエラー');
    }
  });

  document.getElementById('form-video').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('v-msg');
    const bar = document.getElementById('v-progress');
    msg.className = 'muted';
    msg.textContent = 'アップロード中...';
    try {
      const title = vTitle.value.trim();
      const slugInput = vSlug.value.trim();
      const file  = vFile.files[0];
      if (!file) throw new Error('MP4ファイルを選択してください');

      const slug = slugInput || makeSlug(title || (file?.name.replace(/\\.[^.]+$/, '') || 'video'), 'video');

      const created = await postJSON('/api/admin/lessons', { title, slug, type:'video' });

      const presign = await postJSON('/api/admin/lessons/' + created.id + '/video/presign', {
        filename: file.name,
        size: file.size,
        contentType: file.type || 'video/mp4'
      });

      await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('PUT', presign.url);
        xhr.setRequestHeader('Content-Type', file.type || 'video/mp4');
        xhr.upload.onprogress = (ev) => {
          if (ev.lengthComputable) {
            bar.style.display = '';
            bar.value = Math.round(ev.loaded / ev.total * 100);
          }
        };
        xhr.onerror = () => reject(new Error('アップロードに失敗しました'));
        xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error('S3の応答: ' + xhr.status));
        xhr.send(file);
      });

      await postJSON('/api/admin/lessons/' + created.id + '/video/complete', {
        s3_key: presign.key,
        size: file.size,
        duration_sec: null
      });
      await patchJSON('/api/admin/lessons/' + created.id, { published:true, visibility:'public' });

      msg.className = 'ok';
      msg.textContent = 'アップロード完了。ID: ' + created.id + '。ページを移動します...';
      setTimeout(() => location.href = '/vod', 800);
    } catch (err) {
      console.error(err);
      msg.className = 'err';
      msg.textContent = '失敗しました: ' + (err?.message || '不明なエラー');
    } finally {
      bar.style.display = 'none';
      bar.value = 0;
    }
  });
</script>
` }) %>
