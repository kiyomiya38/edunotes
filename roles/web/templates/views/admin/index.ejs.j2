<%- include('../layout', { title: '隰帛ｸｫ繧ｹ繧ｿ繧ｸ繧ｪ | EduNotes', body: `
<section class="container">
  <div class="hero">
    <span class="badge">隰帛ｸｫ繧ｹ繧ｿ繧ｸ繧ｪ</span>
    <h1 class="hero__title">謨呎攝繧貞ｮ牙ｿ・＠縺ｦ蜈ｬ髢九・/h1>
    <p class="hero__subtitle">繝・く繧ｹ繝医→蜍慕判繧剃ｽ懈・縺励∫洒譎る俣縺ｧ蜈ｬ髢九〒縺阪∪縺吶・/p>
  </div>

  <div class="section grid">
    <div class="card">
      <div class="card__eyebrow">讎りｦ・/div>
      <h3>蜿苓ｬ幄・焚</h3>
      <p style="font-size:2rem; margin:0;">${stats.users}</p>
      <p class="muted">蜈ｨ繧ｳ繝ｼ繧ｹ縺ｮ蜿苓ｬ幄・焚縲・/p>
    </div>
    <div class="card">
      <div class="card__eyebrow">繝弱・繝・/div>
      <h3>菴懈・縺輔ｌ縺溘ヮ繝ｼ繝・/h3>
      <p style="font-size:2rem; margin:0;">${stats.notes}</p>
      <p class="muted">蜿苓ｬ幄・′菴懈・縺励◆蟄ｦ鄙偵ヮ繝ｼ繝医・/p>
    </div>
    <div class="card">
      <div class="card__eyebrow">繝ｪ繝ｳ繧ｯ</div>
      <p><a href="/courses">繧ｳ繝ｼ繧ｹ荳隕ｧ</a></p>
      <p><a href="/vod">蜍慕判荳隕ｧ</a></p>
      <p><a href="/docs">蟄ｦ鄙偵ぎ繧､繝・/a></p>
    </div>
  </div>

  <div class="section split">
    <div class="card">
      <div class="card__eyebrow">繝・く繧ｹ繝域蕗譚・/div>
      <h2>Markdown謨呎攝繧偵い繝・・繝ｭ繝ｼ繝・/h2>
      <form id="form-text" class="form">
        <label for="t-title">繧ｿ繧､繝医Ν</label>
        <input id="t-title" type="text" placeholder="萓・ 隨ｬ1遶 繧､繝ｳ繝医Ο" required>

        <label for="t-slug">繧ｹ繝ｩ繝・げ</label>
        <input id="t-slug" type="text" placeholder="intro-1">

        <label for="t-file">Markdown繝輔ぃ繧､繝ｫ (.md)</label>
        <input id="t-file" type="file" accept=".md,text/markdown,text/plain" required>

        <label>
          <input id="t-publish" type="checkbox" checked> 蜿苓ｬ幄・↓蜈ｬ髢九☆繧・        </label>

        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button class="btn btn--primary" type="submit">菴懈・縺吶ｋ</button>
          <span id="t-msg" class="muted"></span>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="card__eyebrow">蜍慕判謨呎攝</div>
      <h2>MP4蜍慕判繧偵い繝・・繝ｭ繝ｼ繝・/h2>
      <form id="form-video" class="form">
        <label for="v-title">繧ｿ繧､繝医Ν</label>
        <input id="v-title" type="text" placeholder="萓・ 隨ｬ1遶 隰帷ｾｩ蜍慕判" required>

        <label for="v-slug">繧ｹ繝ｩ繝・げ</label>
        <input id="v-slug" type="text" placeholder="video-1">

        <label for="v-file">蜍慕判繝輔ぃ繧､繝ｫ (.mp4)</label>
        <input id="v-file" type="file" accept="video/mp4" required>

        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button class="btn btn--primary" type="submit">繧｢繝・・繝ｭ繝ｼ繝・/button>
          <progress id="v-progress" value="0" max="100" style="display:none"></progress>
          <span id="v-msg" class="muted"></span>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  const CSRF = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  const jsonHeaders = () => ({ 'Content-Type':'application/json', 'X-CSRF-Token': CSRF });

  async function postJSON(url, body) {
    const r = await fetch(url, { method:'POST', headers: jsonHeaders(), body: JSON.stringify(body), credentials:'same-origin' });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }
  async function putJSON(url, body) {
    const r = await fetch(url, { method:'PUT', headers: jsonHeaders(), body: JSON.stringify(body), credentials:'same-origin' });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }
  async function patchJSON(url, body) {
    const r = await fetch(url, { method:'PATCH', headers: jsonHeaders(), body: JSON.stringify(body), credentials:'same-origin' });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function makeSlug(input, fallback) {
    const base = String(input || '')
      .normalize('NFKD')
      .replace(/[\\u0300-\\u036f]/g, '')
      .replace(/[^\\w\\s-]/g, ' ')
      .replace(/[_\\s]+/g, '-')
      .toLowerCase()
      .replace(/-+/g, '-')
      .replace(/^-+|-+$/g, '');
    return (base || fallback).slice(0, 80);
  }

  const tTitle = document.getElementById('t-title');
  const tSlug  = document.getElementById('t-slug');
  const tFile  = document.getElementById('t-file');
  tTitle?.addEventListener('input', () => { if (!tSlug.value.trim()) tSlug.value = makeSlug(tTitle.value, 'text'); });
  tFile?.addEventListener('change', () => {
    if (!tSlug.value.trim() && tFile.files[0]) tSlug.value = makeSlug(tFile.files[0].name.replace(/\\.[^.]+$/, ''), 'text');
  });

  const vTitle = document.getElementById('v-title');
  const vSlug  = document.getElementById('v-slug');
  const vFile  = document.getElementById('v-file');
  vTitle?.addEventListener('input', () => { if (!vSlug.value.trim()) vSlug.value = makeSlug(vTitle.value, 'video'); });
  vFile?.addEventListener('change', () => {
    if (!vSlug.value.trim() && vFile.files[0]) vSlug.value = makeSlug(vFile.files[0].name.replace(/\\.[^.]+$/, ''), 'video');
  });

  document.getElementById('form-text').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('t-msg');
    msg.className = 'muted';
    msg.textContent = '菴懈・荳ｭ...';
    try {
      const title = tTitle.value.trim();
      const slugInput = tSlug.value.trim();
      const file  = tFile.files[0];
      const pub   = document.getElementById('t-publish').checked;
      if (!file) throw new Error('Markdown繝輔ぃ繧､繝ｫ繧帝∈謚槭＠縺ｦ縺上□縺輔＞');

      const body_md = await new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onerror = () => rej(new Error('繝輔ぃ繧､繝ｫ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ螟ｱ謨励＠縺ｾ縺励◆'));
        fr.onload  = () => res(String(fr.result || ''));
        fr.readAsText(file, 'utf-8');
      });

      const slug = slugInput || makeSlug(title || (file?.name.replace(/\\.[^.]+$/, '') || 'text'), 'text');

      const created = await postJSON('/api/admin/lessons', { title, slug, type:'text' });
      await putJSON('/api/admin/lessons/' + created.id + '/text', { body_md });
      if (pub) {
        await postJSON('/api/admin/lessons/' + created.id + '/publish', { published:true, visibility:'public' });
      }

      msg.className = 'ok';
      msg.textContent = '菴懈・縺励∪縺励◆縲・D: ' + created.id + '縲ゅ・繝ｼ繧ｸ繧堤ｧｻ蜍輔＠縺ｾ縺・..';
      setTimeout(() => location.href = '/courses', 600);
    } catch (err) {
      console.error(err);
      msg.className = 'err';
      msg.textContent = '螟ｱ謨励＠縺ｾ縺励◆: ' + (err?.message || '荳肴・縺ｪ繧ｨ繝ｩ繝ｼ');
    }
  });

  document.getElementById('form-video').addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = document.getElementById('v-msg');
    const bar = document.getElementById('v-progress');
    msg.className = 'muted';
    msg.textContent = '繧｢繝・・繝ｭ繝ｼ繝我ｸｭ...';
    try {
      const title = vTitle.value.trim();
      const slugInput = vSlug.value.trim();
      const file  = vFile.files[0];
      if (!file) throw new Error('MP4繝輔ぃ繧､繝ｫ繧帝∈謚槭＠縺ｦ縺上□縺輔＞');

      const slug = slugInput || makeSlug(title || (file?.name.replace(/\\.[^.]+$/, '') || 'video'), 'video');

      const created = await postJSON('/api/admin/lessons', { title, slug, type:'video' });

      const presign = await postJSON('/api/admin/lessons/' + created.id + '/video/presign', {
        filename: file.name,
        size: file.size,
        contentType: file.type || 'video/mp4'
      });

      await new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('PUT', presign.url);
        xhr.setRequestHeader('Content-Type', file.type || 'video/mp4');
        xhr.upload.onprogress = (ev) => {
          if (ev.lengthComputable) {
            bar.style.display = '';
            bar.value = Math.round(ev.loaded / ev.total * 100);
          }
        };
        xhr.onerror = () => reject(new Error('繧｢繝・・繝ｭ繝ｼ繝峨↓螟ｱ謨励＠縺ｾ縺励◆'));
        xhr.onload = () => (xhr.status >= 200 && xhr.status < 300) ? resolve() : reject(new Error('S3縺ｮ蠢懃ｭ・ ' + xhr.status));
        xhr.send(file);
      });

      await postJSON('/api/admin/lessons/' + created.id + '/video/complete', {
        s3_key: presign.key,
        size: file.size,
        duration_sec: null
      });
      await patchJSON('/api/admin/lessons/' + created.id, { published:true, visibility:'public' });

      msg.className = 'ok';
      msg.textContent = '繧｢繝・・繝ｭ繝ｼ繝牙ｮ御ｺ・・D: ' + created.id + '縲ゅ・繝ｼ繧ｸ繧堤ｧｻ蜍輔＠縺ｾ縺・..';
      setTimeout(() => location.href = '/vod', 800);
    } catch (err) {
      console.error(err);
      msg.className = 'err';
      msg.textContent = '螟ｱ謨励＠縺ｾ縺励◆: ' + (err?.message || '荳肴・縺ｪ繧ｨ繝ｩ繝ｼ');
    } finally {
      bar.style.display = 'none';
      bar.value = 0;
    }
  });
</script>
` }) %>
