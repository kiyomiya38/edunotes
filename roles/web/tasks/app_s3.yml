# roles/web/tasks/app_s3.yml（完全版）

- name: Ensure app dir exists
  ansible.builtin.file:
    path: /opt/edunotes
    state: directory
    owner: edunotes
    group: edunotes
    mode: "0755"

- name: Deploy package.json (S3-ready)
  ansible.builtin.template:
    src: "package.json.j2"
    dest: "/opt/edunotes/package.json"
    owner: edunotes
    group: edunotes
    mode: "0644"

- name: Deploy server.js (base app with /metrics, /readyz, S3 upload)
  ansible.builtin.template:
    src: "server.js.j2"
    dest: "/opt/edunotes/server.js"
    owner: edunotes
    group: edunotes
    mode: "0644"

- name: Deploy storage.js (S3 backend)
  ansible.builtin.template:
    src: "storage.js.j2"
    dest: "/opt/edunotes/storage.js"
    owner: edunotes
    group: edunotes
    mode: "0644"

# ←←← ここが「直後」です（5個目のタスクのすぐ下） →→→
- name: Render env file
  ansible.builtin.template:
    src: "envfile.j2"
    dest: "/etc/edunotes/env"
    owner: root
    group: root
    mode: "0640"

- name: Remove stale lockfile
  ansible.builtin.file:
    path: /opt/edunotes/package-lock.json
    state: absent

- name: Remove existing node_modules (clean install)
  ansible.builtin.file:
    path: /opt/edunotes/node_modules
    state: absent

- name: Install Node dependencies (prod only, no lock)
  ansible.builtin.command: npm install --omit=dev
  args:
    chdir: "/opt/edunotes"
  environment:
    NODE_ENV: "production"
    HOME: "/home/edunotes"
    npm_config_cache: "/home/edunotes/.npm"
  become: true
  become_user: edunotes
