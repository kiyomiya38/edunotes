- name: Ensure app dir exists
  ansible.builtin.file:
    path: /opt/edunotes
    state: directory
    owner: edunotes
    group: edunotes
    mode: "0755"

- name: Deploy package.json (S3-ready)
  ansible.builtin.template:
    src: "package.json.j2"
    dest: "/opt/edunotes/package.json"
    owner: edunotes
    group: edunotes
    mode: "0644"

- name: Deploy server.js (with /healthz)
  ansible.builtin.template:
    src: "server.js.j2"
    dest: "/opt/edunotes/server.js"
    owner: edunotes
    group: edunotes
    mode: "0644"

- name: Deploy storage.js (S3 backend)
  ansible.builtin.template:
    src: "storage.js.j2"
    dest: "/opt/edunotes/storage.js"
    owner: edunotes
    group: edunotes
    mode: "0644"

# .env はここで作る（起動前に必ず存在させる）
- name: Render env file
  ansible.builtin.template:
    src: "envfile.j2"
    dest: "/etc/edunotes/env"
    owner: root
    group: root
    mode: "0640"

# 依存導入：lock があれば ci、無ければ install
- name: Install Node dependencies (ci if lock, else install)
  ansible.builtin.shell: |
    set -euo pipefail
    cd /opt/edunotes
    if [ -f package-lock.json ]; then
      npm ci --omit=dev
    else
      npm install --omit=dev
    fi
  args:
    executable: /bin/bash
  become: true
  become_user: edunotes
  environment:
    HOME: /home/edunotes
    npm_config_cache: /home/edunotes/.npm
