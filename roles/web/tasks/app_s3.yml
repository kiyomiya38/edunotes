# roles/web/tasks/app_s3.yml
- name: Ensure app dir exists
  ansible.builtin.file:
    path: /opt/edunotes
    state: directory
    owner: edunotes
    group: edunotes
    mode: "0755"

- name: Deploy package.json (S3-ready)
  ansible.builtin.template:
    src: "package.json.j2"
    dest: "/opt/edunotes/package.json"
    owner: edunotes
    group: edunotes
    mode: "0644"

- name: Deploy server.js (backend + metrics + static)
  ansible.builtin.template:
    src: "server.js.j2"
    dest: "/opt/edunotes/server.js"
    owner: edunotes
    group: edunotes
    mode: "0644"

- name: Deploy storage.js (S3 backend helper)
  ansible.builtin.template:
    src: "storage.js.j2"
    dest: "/opt/edunotes/storage.js"
    owner: edunotes
    group: edunotes
    mode: "0644"

# ★ ここからフロント
- name: Ensure public dir
  ansible.builtin.file:
    path: /opt/edunotes/public
    state: directory
    owner: edunotes
    group: edunotes
    mode: "0755"

- name: Deploy index.html
  ansible.builtin.template:
    src: "index.html.j2"
    dest: "/opt/edunotes/public/index.html"
    owner: edunotes
    group: edunotes
    mode: "0644"

# 追加: 管理者向けS3直PUTの簡易確認ページ（必要ない場合は削除OK）
- name: Deploy uploader.html
  ansible.builtin.template:
    src: "uploader.html.j2"
    dest: "/opt/edunotes/public/uploader.html"
    owner: edunotes
    group: edunotes
    mode: "0644"

# クリーンインストール
- name: Remove stale lockfile
  ansible.builtin.file:
    path: "/opt/edunotes/package-lock.json"
    state: absent

- name: Remove existing node_modules (clean install)
  ansible.builtin.file:
    path: "/opt/edunotes/node_modules"
    state: absent

- name: Install Node dependencies (prod only, no lock)
  ansible.builtin.command: npm install --omit=dev
  args: { chdir: "/opt/edunotes" }
  environment:
    NODE_ENV: "production"
    HOME: "/home/edunotes"
    npm_config_cache: "/home/edunotes/.npm"
  become: true
  become_user: edunotes

# ── ここから（SSMの /edunotes/redis/url を直接読む）──
- name: Read Redis URL via AWS CLI (from SSM)
  ansible.builtin.command: >
    aws ssm get-parameter
    --name "/edunotes/redis/url"
    --with-decryption
    --region {{ aws_region }}
    --query 'Parameter.Value'
    --output text
  register: redis_url_cmd
  changed_when: false
  failed_when: false

- name: Override redis_url only when SSM param exists
  ansible.builtin.set_fact:
    redis_url: "{{ redis_url_cmd.stdout | trim }}"
  when: redis_url_cmd.rc == 0 and (redis_url_cmd.stdout | trim) != ''

# Fallback: SSMに /edunotes/redis/url が無い場合のみ、自前でREDIS_URLを組み立てる
# ただし redis_host が空/未設定なら絶対に生成しない（@:6379/0 を防ぐ）
- name: Fallback compose redis_url from redis_host/password when SSM param is missing (strict)
  ansible.builtin.set_fact:
    redis_url: >-
      redis://:{{ (redis_pass | default(redis_password | default('')) ) | urlencode }}@
      {{ redis_host | trim }}:{{ redis_port | default(6379) }}/0
  when:
    - (redis_url is not defined) or (redis_url | trim) == ''
    - redis_host is defined
    - (redis_host | trim) | length > 0

# 生成されたURLが明らかに不正なら捨てる（@:6379/0 等）
- name: Clear redis_url when it looks invalid
  ansible.builtin.set_fact:
    redis_url: ""
  when:
    - redis_url is defined
    - redis_url | trim | regex_search('^redis://:@(:[0-9]+)?/0$')

# ここで“空のREDIS_URLでの誤配備”を防ぎたいなら assert（任意）
- name: Assert redis_url is present (to avoid CSRF/session pitfalls)
  ansible.builtin.assert:
    that:
      - (redis_url | default('') | trim) != ''
    fail_msg: >-
      redis_url が空です。SSM /edunotes/redis/url を作成するか、
      もしくは inventory/group_vars で redis_host/redis_password を設定してください。
    success_msg: "redis_url is set."
  ignore_errors: false

# ── ここまで ───────────────────────────────────────────

- name: Render /etc/edunotes/env
  ansible.builtin.template:
    src: "app.env.j2"
    dest: "/etc/edunotes/env"
    owner: root
    group: root
    mode: "0644"

- name: Ensure app subdirs for views and routes
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: edunotes
    group: edunotes
    mode: "0755"
  loop:
    - /opt/edunotes/views
    - /opt/edunotes/views/notes
    - /opt/edunotes/views/courses    # 追加
    - /opt/edunotes/views/vod        # 追加
    - /opt/edunotes/views/docs       # 追加（docs/show.ejs を流用する場合に必要）
    - /opt/edunotes/routes

- name: Deploy EJS views
  ansible.builtin.template:
    src: "views/{{ item.src }}"
    dest: "/opt/edunotes/views/{{ item.dest }}"
    owner: edunotes
    group: edunotes
    mode: "0644"
  loop:
    - { src: "layout.ejs.j2",         dest: "layout.ejs" }
    - { src: "login.ejs.j2",          dest: "login.ejs" }
    - { src: "signup.ejs.j2",         dest: "signup.ejs" }
    - { src: "notes/index.ejs.j2",    dest: "notes/index.ejs" }
    - { src: "notes/new.ejs.j2",      dest: "notes/new.ejs" }
    - { src: "notes/show.ejs.j2",     dest: "notes/show.ejs" }
    - { src: "notes/edit.ejs.j2",     dest: "notes/edit.ejs" }
    # 追加ビュー
    - { src: "docs/index.ejs.j2",     dest: "docs/index.ejs" }
    - { src: "docs/show.ejs.j2",      dest: "docs/show.ejs" }
    - { src: "courses/index.ejs.j2",  dest: "courses/index.ejs" }
    - { src: "vod/index.ejs.j2",      dest: "vod/index.ejs" }
    - { src: "vod/show.ejs.j2",       dest: "vod/show.ejs" }

- name: Deploy routes
  ansible.builtin.template:
    src: "routes/{{ item }}.j2"
    dest: "/opt/edunotes/routes/{{ item }}"
    owner: edunotes
    group: edunotes
    mode: "0644"
  loop:
    - auth.js
    - notes.js
    - courses.js
    - vod.js
    - docs.js
    - admin.js
    - admin_lessons.js   # 追加（管理API）
    # - lessons.js       # 汎用レッスンAPIを作る場合のみ有効化（今回は不要）

- name: Deploy DB schema
  ansible.builtin.template:
    src: "schema.sql.j2"
    dest: "/opt/edunotes/schema.sql"
    owner: edunotes
    group: edunotes
    mode: "0644"

# ★ psql クライアント（Debian/Ubuntu）
- name: Ensure PostgreSQL client is installed
  ansible.builtin.apt:
    name: postgresql-client
    state: present
    update_cache: yes
  when: ansible_os_family | lower == "debian"

# ★ RDS ルート証明書（必要な場合のみ取得）
- name: Ensure RDS global root bundle exists (if path in env)
  ansible.builtin.shell: |
    set -euo pipefail
    # env を読み、PGSSLROOTCERT が /etc/ssl/certs/rds-global-bundle.pem のときだけ取得
    if [ -f /etc/edunotes/env ]; then set -a; . /etc/edunotes/env; set +a; fi
    TARGET="${PGSSLROOTCERT:-}"
    if [ "${TARGET}" = "/etc/ssl/certs/rds-global-bundle.pem" ] && [ ! -s "${TARGET}" ]; then
      curl -fsSL -o "${TARGET}" https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
      chmod 0644 "${TARGET}"
    fi
  args:
    executable: /bin/bash
  changed_when: false

# ★ env を読んでそのまま DB_URL でスキーマ適用（idempotent）
- name: Apply DB schema (idempotent)
  ansible.builtin.shell: |
    set -euo pipefail
    # /etc/edunotes/env を読み込み
    if [ -f /etc/edunotes/env ]; then set -a; . /etc/edunotes/env; set +a; fi
    if [ -z "${DB_URL:-}" ]; then
      echo "[INFO] DB_URL not set. Skip schema apply."
      exit 0
    fi

    CONN="${DB_URL}"

    # もし verify-full が指定されていて rootcert が見つからない場合は一時的に require に変更して適用
    if [ "${PGSSLMODE:-}" = "verify-full" ] && [ -n "${PGSSLROOTCERT:-}" ] && [ ! -s "${PGSSLROOTCERT}" ]; then
      echo "[WARN] PGSSLROOTCERT not found. Temporarily using sslmode=require for schema apply."
      CONN="${DB_URL}?sslmode=require"
    fi

    # psql 実行（失敗時は即エラー）
    psql "${CONN}" -v ON_ERROR_STOP=1 -f /opt/edunotes/schema.sql
  args:
    executable: /bin/bash
  changed_when: false

# （※ 再起動は最後にまとめる）
- name: Restart edunotes service (after all files are in place)
  ansible.builtin.systemd:
    name: edunotes
    state: restarted
    enabled: yes
    daemon_reload: yes
